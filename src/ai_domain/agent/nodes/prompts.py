from typing import List


def create_agent_prompt(tools: List[dict], is_rag: bool = True) -> str:
    filtered_tools = _format_tools(tools, is_rag)
    if filtered_tools:
        tool_lines = [
            f"- `{tool['name']}`: {tool.get('description', 'без описания')}."
            for tool in filtered_tools
        ]
        tool_description_string = "\n".join(tool_lines)
        tools_section = (
            "**ДОСТУПНЫЕ ИНСТРУМЕНТЫ:**\n---\n"
            f"{tool_description_string}\n---"
        )
    else:
        tools_section = (
            "**У тебя нет доступных инструментов.** "
            "Отвечай на основе истории диалога и своих знаний."
        )

    base_instruction = (
        "Ты — умный ассистент-исследователь. "
        "Твоя задача — проанализировать вопрос пользователя и дать полезный ответ."
    )

    if is_rag and filtered_tools:
        rag_instructions = """
**КЛЮЧЕВОЕ ПРАВИЛО: Если вопрос пользователя содержит несколько независимых тем (например, цена И адрес, или две разные услуги), ты ДОЛЖЕН вызывать инструменты для каждой темы ОТДЕЛЬНО и ПАРАЛЛЕЛЬНО в одном ответе.**

Пример:
- Вопрос пользователя: "Сколько стоят брекеты и где вы находитесь?"
- Твой правильный ответ (вызов инструментов):
  - `knowledge_search(query="стоимость брекетов")`
  - `knowledge_search(query="адрес клиники")`

1. **ИСПОЛЬЗУЙ `knowledge_search`**, если вопрос касается:
   - Цен на услуги (например, "сколько стоят брекеты?")
   - Описания услуг (например, "что такое имплантация?")
   - Адреса, времени работы, контактов клиники
   - Любых других фактических данных, которые могут быть в базе знаний.

2. **НЕ ИСПОЛЬЗУЙ `knowledge_search`**, если вопрос является:
   - Приветствием или прощанием ("привет", "до свидания")
   - Благодарностью ("спасибо")
   - Общим разговором, не требующим фактов ("как дела?", "ты бот?")
"""
    else:
        rag_instructions = """
**ПРАВИЛА ПРИНЯТИЯ РЕШЕНИЙ:**
1. **Разбивай сложные запросы:** Если вопрос пользователя содержит несколько независимых тем, ты ДОЛЖЕН вызывать инструменты для каждой темы ОТДЕЛЬНО и ПАРАЛЛЕЛЬНО.
2. **Выбирай лучший инструмент:** Внимательно прочитай описания инструментов и выбери тот, который лучше всего подходит для под-запроса.
3. **Не используй инструменты** для простого разговора ("привет", "спасибо") или если ни один из инструментов не подходит для ответа.

Проанализируй последний вопрос и вызови один или несколько инструментов, если это необходимо.
"""

    return f"{base_instruction}\n\n{tools_section}\n\n{rag_instructions}"


def create_agent_prompt_short(is_rag: bool = True) -> str:
    base_instruction = (
        "Ты — умный ассистент-исследователь. "
        "Проанализируй вопрос и при необходимости используй доступные инструменты."
    )
    if is_rag:
        rag_instructions = (
            "Если вопрос про цены, услуги, адреса или факты — используй knowledge_search. "
            "Если нужны инструменты — вызывай их. "
            "Не давай финальный ответ до получения результатов инструментов."
        )
    else:
        rag_instructions = (
            "Используй инструменты только если это необходимо. "
            "Если нужны инструменты — вызывай их. "
            "Не давай финальный ответ до получения результатов инструментов."
        )
    return f"{base_instruction}\n{rag_instructions}"


RAG_WITH_INSTRUCTION_PROMPT = """{role_instruction}

Ты должен выполнить ИНСТРУКЦИЮ ПОЛЬЗОВАТЕЛЯ.
Ты видишь список сообщений диалога ЕСТЕСТВЕННОГО формата (Human, AI, Tool).
Сообщения с ролью 'tool' являются результатами вызовов инструментов (например, календаря).
Считай их источником истины и не противоречь им.

Если данных недостаточно — честно скажи об этом.
"""

RAG_WITH_INSTRUCTION_SUFFIX = """
НАЙДЕННЫЕ ДОКУМЕНТЫ:
{found_documents}

Сформируй финальный ответ строго на основании диалога и найденных документов.
ИНСТРУКЦИЯ ПОЛЬЗОВАТЕЛЯ:
{user_instruction}
"""

GENERAL_WITH_INSTRUCTION_PROMPT = """{role_instruction}

Перед тобой история диалога в естественном формате (Human, AI, Tool).
Сообщения c ролью 'tool' — это результаты вызовов инструментов.
Считай их правдивыми фактами и используй при необходимости.
"""

GENERAL_WITH_INSTRUCTION_SUFFIX = """
Ты должен выполнить ИНСТРУКЦИЮ ПОЛЬЗОВАТЕЛЯ.
Используй только историю диалога.
ИНСТРУКЦИЯ ПОЛЬЗОВАТЕЛЯ:
{user_instruction}
"""


def _format_tools(tools: List[dict], is_rag: bool) -> List[dict]:
    return [tool for tool in tools if is_rag or tool.get("name") != "knowledge_search"]
